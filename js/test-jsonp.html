<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test JSONP</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #4a6baf; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
        #result { margin-top: 20px; padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test JSONP</h1>
    
    <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" value="mantrandinhminh@gmail.com">
    </div>
    
    <div class="form-group">
        <label for="password">Mật khẩu:</label>
        <input type="password" id="password" value="123456">
    </div>
    
    <button id="test-btn">Test Login</button>
    
    <div id="result">
        <h3>Kết quả:</h3>
        <div id="result-content">Chưa có kết quả</div>
    </div>

    <script>
        // Thay URL này bằng URL Apps Script của bạn
        const API_URL = "https://script.google.com/macros/s/AKfycby2vIX9RFEhq7E-N7xYuGnmpA_YpWZX3gQoeCV95rpAK_16XZP08HR7ypW1kYBsny9f6Q/exec";
        
        // Hàm gọi API sử dụng JSONP
        function callApiJsonp(params) {
          return new Promise((resolve, reject) => {
            // Tạo URL với tham số
            const url = new URL(API_URL);
            Object.keys(params).forEach(key => {
              url.searchParams.append(key, params[key]);
            });
            
            // Tạo callback name
            const callbackName = 'jsonpCallback_' + Math.round(100000 * Math.random());
            
            // Tạo script element
            const script = document.createElement('script');
            script.src = url.toString() + '&callback=' + callbackName;
            
            // Xử lý response
            window[callbackName] = function(response) {
              delete window[callbackName];
              document.body.removeChild(script);
              resolve(response);
            };
            
            // Xử lý lỗi
            script.onerror = function() {
              delete window[callbackName];
              document.body.removeChild(script);
              reject(new Error('Network error'));
            };
            
            // Thêm script vào DOM
            document.body.appendChild(script);
          });
        }
        
        document.getElementById('test-btn').addEventListener('click', async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = 'Đang gửi yêu cầu...';
            
            try {
                console.log("Attempting login with:", email);
                
                const result = await callApiJsonp({
                    action: "login",
                    email: email,
                    password: password
                });
                
                console.log("Login result:", result);
                
                resultContent.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                
                if (result && result.status === "success") {
                    alert('Đăng nhập thành công!');
                    localStorage.setItem("user", JSON.stringify(result.user));
                } else {
                    alert(result?.message || "Đăng nhập thất bại");
                }
            } catch (error) {
                console.error("Login error:", error);
                resultContent.innerHTML = `Lỗi: ${error.message}`;
                alert('Lỗi kết nối: ' + error.message);
            }
        });
    </script>
</body>
</html>
